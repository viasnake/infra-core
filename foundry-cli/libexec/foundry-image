#!/usr/bin/env bash

set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/foundry-common"

ROOT="$(foundry_root)"

image_build() {
  if ! foundry_has_command packer; then
    foundry_fail 1 true "packer command is missing"
  fi

  local template="${ROOT}/packer/foundry.pkr.hcl"

  if [ "$#" -gt 0 ] && [[ "$1" != -* ]]; then
    template="$1"
    shift
  fi

  if [ ! -f "$template" ]; then
    foundry_fail 1 false "packer template not found: ${template}"
  fi

  if [ "$(foundry_output_format)" = "human" ]; then
    printf 'building image with packer template: %s\n' "$template" >&2
  fi

  exec packer build "$@" "$template"
}

subcommand="${1:-}"
shift || true

case "$subcommand" in
build)
  image_build "$@"
  ;;
*)
  foundry_fail 2 false "usage: foundry image build [template] [packer args...]"
  ;;
esac
