#!/usr/bin/env bash

set -euo pipefail

foundry_output_format() {
  local fmt="${FOUNDRY_OUTPUT:-human}"
  case "$fmt" in
  human | json | yaml)
    printf '%s\n' "$fmt"
    ;;
  *)
    printf '%s\n' "human"
    ;;
  esac
}

foundry_emit_json() {
  local payload="$1"
  local fmt
  fmt="$(foundry_output_format)"

  case "$fmt" in
  human)
    printf '%s\n' "$payload"
    ;;
  json)
    if command -v jq >/dev/null 2>&1; then
      printf '%s\n' "$payload" | jq .
    else
      printf '%s\n' "$payload"
    fi
    ;;
  yaml)
    python3 - "$payload" <<'PY'
import json
import sys

def dump_yaml(value, indent=0):
    prefix = " " * indent
    if isinstance(value, dict):
        for k, v in value.items():
            if isinstance(v, (dict, list)):
                print(f"{prefix}{k}:")
                dump_yaml(v, indent + 2)
            else:
                print(f"{prefix}{k}: {scalar(v)}")
    elif isinstance(value, list):
        for item in value:
            if isinstance(item, (dict, list)):
                print(f"{prefix}-")
                dump_yaml(item, indent + 2)
            else:
                print(f"{prefix}- {scalar(item)}")

def scalar(v):
    if isinstance(v, bool):
        return "true" if v else "false"
    if v is None:
        return "null"
    if isinstance(v, (int, float)):
        return str(v)
    s = str(v)
    if s == "" or any(ch in s for ch in [":", "#", "{", "}", "[", "]", "\n", "'", '"']):
        return json.dumps(s)
    return s

data = json.loads(sys.argv[1])
dump_yaml(data)
PY
    ;;
  esac
}

foundry_emit_object() {
  local json_payload="$1"
  local human_renderer="$2"
  local fmt
  fmt="$(foundry_output_format)"

  if [ "$fmt" = "human" ]; then
    "$human_renderer" "$json_payload"
    return 0
  fi

  foundry_emit_json "$json_payload"
}

foundry_fail() {
  local code="$1"
  local retryable="$2"
  local message="$3"
  local fmt
  fmt="$(foundry_output_format)"

  if [ "$fmt" = "human" ]; then
    printf 'ERROR: %s (retryable=%s)\n' "$message" "$retryable" >&2
  else
    foundry_emit_json "{\"error\":\"${message}\",\"retryable\":${retryable},\"exit_code\":${code}}"
  fi

  exit "$code"
}

foundry_bool_json() {
  local value="$1"
  if [ "$value" = "true" ] || [ "$value" = "1" ] || [ "$value" = "yes" ]; then
    printf 'true\n'
    return 0
  fi
  printf 'false\n'
}

foundry_json_string() {
  python3 - "$1" <<'PY'
import json
import sys

print(json.dumps(sys.argv[1]))
PY
}

foundry_has_command() {
  command -v "$1" >/dev/null 2>&1
}

foundry_command_version() {
  local cmd="$1"
  local fallback="$2"
  if ! foundry_has_command "$cmd"; then
    printf 'not-found\n'
    return 0
  fi

  local output
  output="$($cmd --version 2>/dev/null | head -n 1 || true)"
  if [ -z "$output" ] && [ -n "$fallback" ]; then
    output="$($cmd "$fallback" 2>/dev/null | head -n 1 || true)"
  fi
  if [ -z "$output" ]; then
    output="available"
  fi
  printf '%s\n' "$output"
}

foundry_require_arg() {
  local value="$1"
  local message="$2"
  if [ -z "$value" ]; then
    foundry_fail 2 false "$message"
  fi
}

foundry_run() {
  if [ "${FOUNDRY_TRACE:-0}" = "1" ]; then
    printf 'RUN: %s\n' "$*" >&2
  fi
  "$@"
}
