#!/usr/bin/env bash

set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/foundry-common"

ROOT="${FOUNDRY_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"
SECRETS_DIR="${ROOT}/secrets"

secret_snapshot() {
  local has_dir="false"
  local has_samples="false"
  local has_cloudflare_env="false"

  if [ -d "$SECRETS_DIR" ]; then
    has_dir="true"
  fi

  if [ -f "${SECRETS_DIR}/cloudlared.env.sample" ] && [ -f "${SECRETS_DIR}/ansible.env.sample" ]; then
    has_samples="true"
  fi

  if [ -f "${SECRETS_DIR}/cloudlared.env" ]; then
    has_cloudflare_env="true"
  fi

  printf '{"command":"secret","ownership":"outside-foundry","checks":{"secrets_dir":%s,"sample_files":%s,"cloudflare_env":%s}}\n' \
    "$(foundry_bool_json "${has_dir}")" \
    "$(foundry_bool_json "${has_samples}")" \
    "$(foundry_bool_json "${has_cloudflare_env}")"
}

secret_human() {
  python3 - "$1" <<'PY'
import json
import sys

data = json.loads(sys.argv[1])
print("Foundry secret")
print("- ownership: {}".format(data["ownership"]))
for name, ok in data["checks"].items():
    print("- [{}] {}".format("ok" if ok else "warn", name))
PY
}

subcommand="${1:-doctor}"
case "$subcommand" in
doctor | status)
  payload="$(secret_snapshot)"
  foundry_emit_object "$payload" secret_human
  ;;
*)
  foundry_fail 2 false "usage: foundry secret [doctor|status]"
  ;;
esac
