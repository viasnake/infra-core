#!/usr/bin/env bash

set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/foundry-common"

ROOT="${FOUNDRY_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

if ! foundry_has_command ansible-playbook; then
  foundry_fail 1 true "ansible-playbook command is missing"
fi

playbook="${ROOT}/ansible/site.yml"

if [ "$#" -gt 0 ] && [[ "$1" != -* ]]; then
  playbook="$1"
  shift
fi

if [ ! -f "$playbook" ]; then
  foundry_fail 1 false "ansible playbook not found: ${playbook}"
fi

if [ "$(foundry_output_format)" = "human" ]; then
  printf 'converging with ansible playbook: %s\n' "$playbook" >&2
fi

exec ansible-playbook "$playbook" "$@"
