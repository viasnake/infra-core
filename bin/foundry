#!/usr/bin/env bash

set -euo pipefail

SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SELF_DIR}/.." && pwd)"
LIBEXEC_DIR="${ROOT_DIR}/libexec"

if [ "$#" -eq 0 ]; then
  exec "${LIBEXEC_DIR}/foundry-help"
fi

OUTPUT_FORMAT="human"
ARGS=()

while [ "$#" -gt 0 ]; do
  case "$1" in
  --output)
    shift
    if [ "$#" -eq 0 ]; then
      echo "missing value for --output" >&2
      exit 2
    fi
    OUTPUT_FORMAT="$1"
    ;;
  --output=*)
    OUTPUT_FORMAT="${1#--output=}"
    ;;
  *)
    ARGS+=("$1")
    ;;
  esac
  shift
done

if [ "${#ARGS[@]}" -eq 0 ]; then
  exec "${LIBEXEC_DIR}/foundry-help"
fi

CMD="${ARGS[0]}"
REST=("${ARGS[@]:1}")
TARGET="${LIBEXEC_DIR}/foundry-${CMD}"

if [ ! -x "${TARGET}" ]; then
  echo "unknown command: ${CMD}" >&2
  exec "${LIBEXEC_DIR}/foundry-help"
fi

export FOUNDRY_OUTPUT="${OUTPUT_FORMAT}"
export FOUNDRY_ROOT="${ROOT_DIR}"

exec "${TARGET}" "${REST[@]}"
